<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Checkout - Apple Store</title>
  <!-- Font & Tailwind (Optional but good for consistent styling) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="checkout1.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body { font-family: 'Inter', sans-serif; }
    
    /* Modal Custom Styles */
    .success-modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.6); display: none;
      justify-content: center; align-items: center; z-index: 1001;
    }
    .success-modal {
      background-color: white; padding: 30px 40px; border-radius: 18px;
      text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.2);
      width: 90%; max-width: 400px; transform: scale(0.9); animation: scaleUp 0.3s forwards;
    }
    @keyframes scaleUp { to { transform: scale(1); } }
    
    /* --- CSS CHO PHẦN VOUCHER (MỚI) --- */
    .voucher-section {
        margin-top: 15px;
        padding: 15px;
        background-color: #f9f9f9;
        border-radius: 8px;
        border: 1px dashed #ccc;
    }
    .voucher-select {
        width: 100%;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #ddd;
        margin-top: 5px;
        font-family: inherit;
    }
    .discount-row {
        display: flex;
        justify-content: space-between;
        color: #28a745; /* Màu xanh lá cho giảm giá */
        font-weight: bold;
        margin-top: 10px;
        font-size: 0.9em;
    }
  </style>
</head>
<body>
  
  <div class="checkout-container">
      <h1>Your Shopping Cart</h1>
      <table class="cart-table" id="checkout-table">
        <thead>
          <tr>
            <th>Image</th>
            <th>Product</th>
            <th>Category</th>
            <th>Price</th>
            <th>Qty</th>
          </tr>
        </thead>
        <tbody>
          <!-- Items injected via JS -->
        </tbody>
      </table>

      <div class="actions">
        <a href="index.html" class="btn btn-secondary">← Continue Shopping</a>
        <button class="btn btn-payment-checkout" onclick="openOrderModal()">Proceed to Checkout</button>
      </div>
  </div>

<!-- Order Modal -->
<div class="order-modal-overlay" id="order-modal-overlay">
  <div class="order-modal">
    <div class="order-modal-header">
      <h2>Confirm Order</h2>
      <button type="button" class="order-modal-close-btn" onclick="closeOrderModal()">&times;</button>
    </div>
    <div class="order-modal-body">
      
      <!-- Column 1: Info -->
      <section>
        <h3>Shipping Details</h3>
        <div class="form-group">
          <label>Recipient Name <span class="required">*</span></label>
          <input type="text" id="recipient-name-checkout" required>
        </div>
        <div class="form-group">
          <label>Phone Number <span class="required">*</span></label>
          <input type="tel" id="recipient-phone-checkout" required>
        </div>
        <div class="form-group">
          <label>Address <span class="required">*</span></label>
          <input type="text" id="recipient-address-checkout" required>
        </div>
        <div class="form-group">
          <label>Notes</label>
          <textarea id="recipient-notes-checkout" rows="2"></textarea>
        </div>
      </section>

      <!-- Column 2: Summary & Voucher -->
      <section class="order-summary-section">
        <h3>Order Summary</h3>
        <div id="order-modal-product-summary-checkout" class="product-summary-list"></div>
        
        <!-- ========================================== -->
        <!-- KHU VỰC CHỌN VOUCHER (ĐÃ ĐƯỢC THÊM VÀO) -->
        <!-- ========================================== -->
        <div class="voucher-section">
            <label for="voucher-select" style="font-weight: 600; font-size: 0.9em;">Apply Voucher</label>
            <select id="voucher-select" class="voucher-select" onchange="applyVoucher()">
                <option value="0" data-code="">Select a voucher...</option>
                <!-- Options sẽ được thêm vào bằng Javascript -->
            </select>
        </div>

        <div class="order-calculations" style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 10px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span>Subtotal:</span>
                <span id="subtotal-amount">0 ₫</span>
            </div>
            
            <!-- Dòng hiển thị tiền giảm giá -->
            <div class="discount-row" id="discount-row" style="display: none;">
                <span>Discount:</span>
                <span id="discount-amount">-0 ₫</span>
            </div>
            
            <div class="order-modal-total" style="margin-top: 10px; font-size: 1.2em;">
                <span>Total Payment:</span>
                <span id="order-modal-total-amount-checkout">0 ₫</span>
            </div>
        </div>
      </section>

      <section>
        <h3>Payment Method</h3>
        <div class="payment-option">
          <input type="radio" id="cod-checkout" name="payment-method" value="cod" checked>
          <label for="cod-checkout"><i class="fa fa-truck"></i> Cash on Delivery (COD)</label>
        </div>
      </section>
    </div>
    <div class="order-modal-footer">
      <button class="btn-place-order" onclick="submitOrderCheckout()">PLACE ORDER</button>
    </div>
  </div>
</div>

<!-- Success Modal -->
 <div class="success-modal-overlay" id="success-modal-overlay">
    <div class="success-modal">
        <div class="icon" style="font-size: 50px; color: #28a745; margin-bottom: 10px;">&#10004;</div>
        <h2>Order Successful!</h2>
        <p>Thank you for your purchase.</p>
        <p class="text-sm text-gray-500">Order ID: <strong id="success-order-id"></strong></p>
        <button class="btn-ok" style="background: #0071e3; color: white; padding: 10px 30px; border-radius: 20px; border: none; cursor: pointer; margin-top: 15px;" onclick="closeSuccessModal()">Continue Shopping</button>
    </div>
 </div>

 <script>
    let serverCartItems = [];
    let userVouchers = []; // Biến lưu danh sách voucher của user
    let currentDiscount = 0; // Biến lưu số tiền đang được giảm
    let currentSubtotal = 0; // Biến lưu tổng tiền hàng

    function getAuthToken() {
        return localStorage.getItem('accessToken');
    }

    async function loadCartFromServer() {
        const token = getAuthToken();
        const tbody = document.querySelector('#checkout-table tbody');
        const payBtn = document.querySelector('.btn-payment-checkout');

        if (!token) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Please <a href="login/login.html" style="color: #0071e3;">login</a> to view your cart.</td></tr>';
            if(payBtn) payBtn.disabled = true;
            return;
        }

        try {
            // 1. Tải Giỏ hàng
            const cartRes = await fetch('http://127.0.0.1:3000/api/cart', { headers: { 'token': `Bearer ${token}` } });
            const cartData = await cartRes.json();
            serverCartItems = cartData.items || [];
            
            // 2. Tải Profile để lấy Voucher (QUAN TRỌNG)
            const profileRes = await fetch('http://127.0.0.1:3000/api/users/profile', { headers: { 'token': `Bearer ${token}` } });
            const profileData = await profileRes.json();
            if (profileData.user && profileData.user.myVouchers) {
                // Chỉ lấy những voucher chưa sử dụng (isUsed: false)
                userVouchers = profileData.user.myVouchers.filter(v => !v.isUsed);
            }

            displayCartItemsInTable();

        } catch (error) {
            console.error("Error loading data:", error);
            tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Error loading data.</td></tr>`;
        }
    }

    function displayCartItemsInTable() {
        const tbody = document.querySelector('#checkout-table tbody');
        const payBtn = document.querySelector('.btn-payment-checkout');
        tbody.innerHTML = '';

        if (serverCartItems.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 20px;">Your cart is empty.</td></tr>';
            if(payBtn) payBtn.disabled = true;
        } else {
            if(payBtn) payBtn.disabled = false;
            serverCartItems.forEach(item => {
                const tr = document.createElement('tr');
                const formattedPrice = item.price.toLocaleString('vi-VN') + ' ₫';
                tr.innerHTML = `
                    <td><img src="${item.image_url}" alt="${item.name}" style="width: 60px; height: 60px; object-fit: contain;"></td>
                    <td>${item.name}</td>
                    <td>${item.category || '-'}</td>
                    <td>${formattedPrice}</td>
                    <td>${item.quantity}</td>
                `;
                tbody.appendChild(tr);
            });
        }
    }

    // --- LOGIC MỞ MODAL VÀ CHUẨN BỊ VOUCHER ---

    function openOrderModal() {
        if (serverCartItems.length === 0) return alert("Cart is empty.");
        
        const summaryDiv = document.getElementById('order-modal-product-summary-checkout');
        summaryDiv.innerHTML = '';
        currentSubtotal = 0;

        // 1. Hiển thị danh sách sản phẩm tóm tắt
        serverCartItems.forEach(item => {
            const itemTotal = item.price * item.quantity;
            currentSubtotal += itemTotal;
            
            const div = document.createElement('div');
            div.style.cssText = "display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9em;";
            div.innerHTML = `
                <span>${item.name} (x${item.quantity})</span>
                <span>${itemTotal.toLocaleString('vi-VN')} ₫</span>
            `;
            summaryDiv.appendChild(div);
        });

        // 2. Đổ dữ liệu Voucher vào Dropdown (PHẦN MỚI)
        const voucherSelect = document.getElementById('voucher-select');
        voucherSelect.innerHTML = '<option value="0" data-code="">-- Select a Voucher --</option>';
        
        if (userVouchers.length > 0) {
            userVouchers.forEach(v => {
                const option = document.createElement('option');
                option.value = v.discountAmount; // Giá trị của option là số tiền giảm
                option.dataset.code = v.code;    // Lưu mã voucher vào data-code
                option.textContent = `${v.code} - Giảm ${v.discountAmount.toLocaleString()}₫`;
                voucherSelect.appendChild(option);
            });
        } else {
            const option = document.createElement('option');
            option.textContent = "No vouchers available";
            option.disabled = true;
            voucherSelect.appendChild(option);
        }

        // Reset lại giá trị tính toán
        document.getElementById('voucher-select').value = "0";
        applyVoucher(); // Tính lại tổng tiền ban đầu

        document.getElementById('order-modal-overlay').classList.add('active');
    }

    // --- HÀM ÁP DỤNG VOUCHER (TÍNH TOÁN LẠI TIỀN) ---
    function applyVoucher() {
        const select = document.getElementById('voucher-select');
        const discountVal = parseFloat(select.value) || 0;
        currentDiscount = discountVal;

        // Tính tổng tiền cuối cùng
        let finalTotal = currentSubtotal - currentDiscount;
        if (finalTotal < 0) finalTotal = 0;

        // Cập nhật giao diện
        document.getElementById('subtotal-amount').textContent = currentSubtotal.toLocaleString('vi-VN') + ' ₫';
        
        const discountRow = document.getElementById('discount-row');
        if (currentDiscount > 0) {
            discountRow.style.display = 'flex';
            document.getElementById('discount-amount').textContent = `-${currentDiscount.toLocaleString('vi-VN')} ₫`;
        } else {
            discountRow.style.display = 'none';
        }

        document.getElementById('order-modal-total-amount-checkout').textContent = finalTotal.toLocaleString('vi-VN') + ' ₫';
    }

    // --- GỬI ĐƠN HÀNG ---
    async function submitOrderCheckout() {
        const name = document.getElementById('recipient-name-checkout').value.trim();
        const phone = document.getElementById('recipient-phone-checkout').value.trim();
        const address = document.getElementById('recipient-address-checkout').value.trim();
        const notes = document.getElementById('recipient-notes-checkout').value.trim();
        
        if (!name || !phone || !address) return alert("Please fill in shipping details.");

        // Lấy mã voucher đang chọn
        const voucherSelect = document.getElementById('voucher-select');
        const selectedOption = voucherSelect.options[voucherSelect.selectedIndex];
        const voucherCode = selectedOption.dataset.code || null;
        
        // Tính lại lần cuối
        let finalTotal = currentSubtotal - currentDiscount;
        if (finalTotal < 0) finalTotal = 0;

        const orderData = {
            recipientName: name,
            recipientPhone: phone,
            recipientAddress: address,
            recipientNotes: notes,
            paymentMethod: 'COD',
            items: serverCartItems.map(item => ({
                name: item.name,
                price: item.price.toLocaleString('vi-VN') + ' ₫',
                qty: item.quantity,
                image: item.image_url
            })),
            totalAmountString: finalTotal.toLocaleString('vi-VN') + ' ₫',
            totalAmountNumeric: currentSubtotal, // Giá gốc
            finalAmount: finalTotal,             // Giá sau khi giảm
            appliedVoucher: voucherCode          // Mã voucher đã dùng
        };

        try {
            const res = await fetch('http://127.0.0.1:3000/api/orders', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'token': `Bearer ${getAuthToken()}`
                },
                body: JSON.stringify(orderData),
            });
            
            const data = await res.json();
            if (!res.ok) throw new Error(data.message || "Order failed.");
            
            closeOrderModal();
            showSuccessModal(data.order._id || "SUCCESS");
            
            serverCartItems = [];
            displayCartItemsInTable();

        } catch (error) {
            console.error(error);
            alert(`Error: ${error.message}`);
        }
    }

    function closeOrderModal() {
        document.getElementById('order-modal-overlay').classList.remove('active');
    }
    function showSuccessModal(id) {
        document.getElementById('success-order-id').textContent = id;
        document.getElementById('success-modal-overlay').style.display = 'flex';
    }
    function closeSuccessModal() {
        window.location.href = 'index.html';
    }

    document.addEventListener('DOMContentLoaded', loadCartFromServer);
  </script>
</body>
</html>